<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSS Admin - Products</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#f8fafc;color:#0f172a}
    h1{margin:0 0 12px}
    .wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;font-size:14px}
    th{background:#f1f5f9}
    .toolbar{display:flex;gap:8px;margin:8px 0;align-items:center}
    input,select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
    button{background:#F58220;color:#fff;border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer}
    .danger{background:#b91c1c}
    .row-actions{display:flex;gap:6px}
    .muted{color:#64748b;font-size:12px}
    label{font-size:12px;color:#334155}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
  <link rel="icon" href="data:,">
  <script>
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    function q(name){ const u = new URL(location.href); return u.searchParams.get(name) }
    const BASE = q('base') || 'http://localhost:4000';
    async function api(path, opts){
      const res = await fetch(BASE + path, opts);
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }
  </script>
</head>
<body>
  <h1>Products <span class="muted">(Admin)</span></h1>
  <div class="toolbar">
    <input id="search" placeholder="Search name or SKU" style="flex:1"/>
    <select id="cat">
      <option value="">All Categories</option>
      <option value="fert">Fertilizers</option>
      <option value="seed">Seeds</option>
      <option value="other">Other</option>
    </select>
    <select id="active">
      <option value="">All</option>
      <option value="1">Active</option>
      <option value="0">Inactive</option>
    </select>
    <button onclick="loadList()">Filter</button>
    <a href="/admin/index.html" style="margin-left:auto;text-decoration:none"><button>Dashboard</button></a>
  </div>
  <div class="wrap">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>SKU</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="card">
      <h3 id="formTitle">Add Product</h3>
      <div class="grid2">
        <div>
          <label>Name</label>
          <input id="name" placeholder="Product name" />
        </div>
        <div>
          <label>Category</label>
          <select id="category">
            <option value="fert">Fertilizers</option>
            <option value="seed">Seeds</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label>Price (₹)</label>
          <input id="price" type="number" step="0.01" placeholder="0" />
        </div>
        <div>
          <label>Stock</label>
          <input id="stock" type="number" placeholder="0" />
        </div>
        <div>
          <label>SKU</label>
          <input id="sku" placeholder="Optional" />
        </div>
        <div>
          <label>Unit</label>
          <input id="unit" placeholder="bag, kg, pack" />
        </div>
        <div>
          <label>Image URL</label>
          <input id="imageUrl" placeholder="https://..." />
        </div>
        <div>
          <label>Status</label>
          <select id="isActive"><option value="1">Active</option><option value="0">Inactive</option></select>
        </div>
      </div>
      <div class="toolbar">
        <button onclick="save()" id="saveBtn">Save</button>
        <button onclick="resetForm()" class="danger" id="cancelBtn" style="display:none">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let editingId = null;
    async function loadList(){
      const params = new URLSearchParams();
      const qv = $('#search').value.trim(); if (qv) params.set('q', qv);
      const cv = $('#cat').value; if (cv) params.set('category', cv);
      const av = $('#active').value; if (av !== '') params.set('active', av);
      const list = await api('/products?' + params.toString());
      const tbody = $('#rows'); tbody.innerHTML = '';
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.category}</td>
          <td>₹${Number(p.price||0).toFixed(2)}</td>
          <td>${p.stock ?? 0}</td>
          <td>${p.sku || ''}</td>
          <td>${p.isActive ? 'Active' : 'Inactive'}</td>
          <td class="row-actions">
            <button onclick="edit('${p.id}')">Edit</button>
            <button class="danger" onclick="delp('${p.id}')">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    async function save(){
      const body = {
        name: $('#name').value.trim(),
        category: $('#category').value,
        price: parseFloat($('#price').value || '0'),
        stock: parseInt($('#stock').value || '0', 10),
        sku: $('#sku').value.trim() || null,
        unit: $('#unit').value.trim() || 'unit',
        imageUrl: $('#imageUrl').value.trim(),
        isActive: $('#isActive').value === '1'
      };
      if (!body.name) { alert('Name is required'); return; }
      if (editingId){
        await api('/products/' + editingId, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      } else {
        await api('/products', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      }
      resetForm();
      await loadList();
    }
    async function edit(id){
      const p = await api('/products/' + id);
      editingId = id;
      $('#formTitle').textContent = 'Edit Product';
      $('#saveBtn').textContent = 'Update';
      $('#cancelBtn').style.display = '';
      $('#name').value = p.name || '';
      $('#category').value = p.category || 'other';
      $('#price').value = p.price || 0;
      $('#stock').value = p.stock || 0;
      $('#sku').value = p.sku || '';
      $('#unit').value = p.unit || 'unit';
      $('#imageUrl').value = p.imageUrl || '';
      $('#isActive').value = p.isActive ? '1' : '0';
    }
    async function delp(id){
      if (!confirm('Delete this product?')) return;
      await api('/products/' + id, { method:'DELETE' });
      if (editingId === id) resetForm();
      await loadList();
    }
    function resetForm(){
      editingId = null;
      $('#formTitle').textContent = 'Add Product';
      $('#saveBtn').textContent = 'Save';
      $('#cancelBtn').style.display = 'none';
      $$('#name,#price,#stock,#sku,#unit,#imageUrl').forEach(el=> el.value='');
      $('#category').value = 'fert';
      $('#isActive').value = '1';
    }
    loadList();
  </script>
</body>
</html>
