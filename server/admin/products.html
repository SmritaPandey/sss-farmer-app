<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSS Admin - Products</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;background:#f8fafc;color:#0f172a}
    h1{margin:0 0 12px}
    .wrap{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;font-size:14px}
    th{background:#f1f5f9}
    .toolbar{display:flex;gap:8px;margin:8px 0;align-items:center}
    input,select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
    button{background:#F58220;color:#fff;border:0;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer}
    .danger{background:#b91c1c}
    .row-actions{display:flex;gap:6px}
    .muted{color:#64748b;font-size:12px}
    label{font-size:12px;color:#334155}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
  <link rel="icon" href="data:,">
  
</head>
<body>
  <h1>Products <span class="muted">(Admin)</span></h1>
  <div class="toolbar">
    <input id="search" placeholder="Search name or SKU" style="flex:1"/>
    <select id="cat">
      <option value="">All Categories</option>
      <option value="fert">Fertilizers</option>
      <option value="seed">Seeds</option>
      <option value="other">Other</option>
    </select>
    <select id="active">
      <option value="">All</option>
      <option value="1">Active</option>
      <option value="0">Inactive</option>
    </select>
    <button onclick="loadList()">Filter</button>
    <a href="/admin/index.html" style="margin-left:auto;text-decoration:none"><button>Dashboard</button></a>
  </div>
  <div class="wrap">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>SKU</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="card">
      <h3 id="formTitle">Add Product</h3>
      <div class="grid2">
        <div>
          <label>Name</label>
          <input id="name" placeholder="Product name" />
        </div>
        <div>
          <label>Category</label>
          <select id="category">
            <option value="fert">Fertilizers</option>
            <option value="seed">Seeds</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label>Price (₹)</label>
          <input id="price" type="number" step="0.01" placeholder="0" />
        </div>
        <div>
          <label>Stock</label>
          <input id="stock" type="number" placeholder="0" />
        </div>
        <div>
          <label>SKU</label>
          <input id="sku" placeholder="Optional" />
        </div>
        <div>
          <label>Unit</label>
          <input id="unit" placeholder="bag, kg, pack" />
        </div>
        <div>
          <label>Image URL</label>
          <input id="imageUrl" placeholder="https://..." />
        </div>
        <div>
          <label>Status</label>
          <select id="isActive"><option value="1">Active</option><option value="0">Inactive</option></select>
        </div>
      </div>
      <div class="toolbar">
        <button onclick="save()" id="saveBtn">Save</button>
        <button onclick="resetForm()" class="danger" id="cancelBtn" style="display:none">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, query, where, orderBy, updateDoc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // Try to load Firebase config from optional script /admin/firebase-config.js
    let firebaseConfig = window.firebaseConfig || undefined;
    try { /* no-op if not present */ } catch {}

    let db = null;
    if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    }

    const BASE = (new URL(location.href)).searchParams.get('base') || '';
    async function rest(path, opts){
      if (!BASE) throw new Error('No REST base');
      const res = await fetch(BASE + path, opts);
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    let editingId = null;

    async function loadList(){
      const tbody = $('#rows'); tbody.innerHTML = '';
      const qv = $('#search').value.trim();
      const category = $('#cat').value || undefined;
      const active = $('#active').value === '' ? undefined : ($('#active').value === '1');

      let list = [];
      if (db) {
        const col = collection(db, 'products');
        const clauses = [];
        if (category) clauses.push(where('category','==',category));
        if (typeof active === 'boolean') clauses.push(where('isActive','==',active));
        const qy = clauses.length ? query(col, ...clauses) : col;
        const snap = await getDocs(qy);
        list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if (qv) list = list.filter(p => (p.name||'').toLowerCase().includes(qv.toLowerCase()) || (p.sku||'').toLowerCase().includes(qv.toLowerCase()));
      } else {
        // REST fallback
        const params = new URLSearchParams();
        if (qv) params.set('q', qv);
        if (category) params.set('category', category);
        if (typeof active === 'boolean') params.set('active', active ? '1':'0');
        list = await rest('/products?' + params.toString());
      }
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.category}</td>
          <td>₹${Number(p.price||0).toFixed(2)}</td>
          <td>${p.stock ?? 0}</td>
          <td>${p.sku || ''}</td>
          <td>${p.isActive ? 'Active' : 'Inactive'}</td>
          <td class="row-actions">
            <button data-id="${p.id}" class="edit">Edit</button>
            <button data-id="${p.id}" class="delete danger">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      // Attach handlers
      $$('.edit').forEach(btn => btn.addEventListener('click', () => edit(btn.getAttribute('data-id'))));
      $$('.delete').forEach(btn => btn.addEventListener('click', () => delp(btn.getAttribute('data-id'))));
    }

    async function save(){
      const body = {
        name: $('#name').value.trim(),
        category: $('#category').value,
        price: parseFloat($('#price').value || '0'),
        stock: parseInt($('#stock').value || '0', 10),
        sku: $('#sku').value.trim() || null,
        unit: $('#unit').value.trim() || 'unit',
        imageUrl: $('#imageUrl').value.trim(),
        isActive: $('#isActive').value === '1'
      };
      if (!body.name) { alert('Name is required'); return; }
      if (db) {
        if (editingId) {
          await updateDoc(doc(db, 'products', editingId), body);
        } else {
          await addDoc(collection(db, 'products'), { ...body, createdAt: Date.now(), updatedAt: Date.now() });
        }
      } else {
        if (!BASE) { alert('REST base not provided'); return; }
        if (editingId){
          await rest('/products/' + editingId, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        } else {
          await rest('/products', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        }
      }
      resetForm();
      await loadList();
    }

    async function edit(id){
      let p = null;
      if (db) {
        const snap = await getDoc(doc(db, 'products', id));
        if (snap.exists()) p = { id, ...snap.data() };
      } else {
        p = await rest('/products/' + id);
      }
      if (!p) return;
      editingId = id;
      $('#formTitle').textContent = 'Edit Product';
      $('#saveBtn').textContent = 'Update';
      $('#cancelBtn').style.display = '';
      $('#name').value = p.name || '';
      $('#category').value = p.category || 'other';
      $('#price').value = p.price || 0;
      $('#stock').value = p.stock || 0;
      $('#sku').value = p.sku || '';
      $('#unit').value = p.unit || 'unit';
      $('#imageUrl').value = p.imageUrl || '';
      $('#isActive').value = p.isActive ? '1' : '0';
    }

    async function delp(id){
      if (!confirm('Delete this product?')) return;
      if (db) {
        await deleteDoc(doc(db, 'products', id));
      } else {
        await rest('/products/' + id, { method:'DELETE' });
      }
      if (editingId === id) resetForm();
      await loadList();
    }

    function resetForm(){
      editingId = null;
      $('#formTitle').textContent = 'Add Product';
      $('#saveBtn').textContent = 'Save';
      $('#cancelBtn').style.display = 'none';
      $$('#name,#price,#stock,#sku,#unit,#imageUrl').forEach(el=> el.value='');
      $('#category').value = 'fert';
      $('#isActive').value = '1';
    }

    // Expose to buttons
    window.save = save;
    window.resetForm = resetForm;
    window.edit = edit;
    window.delp = delp;

    // Load optional config script
    const cfgScript = document.createElement('script');
    cfgScript.src = '/admin/firebase-config.js';
    cfgScript.onload = () => {
      if (window.firebaseConfig && window.firebaseConfig.apiKey) {
        location.reload();
      }
    };
    cfgScript.onerror = () => {};
    document.head.appendChild(cfgScript);

    // Initial load
    loadList();
  </script>
</body>
</html>
